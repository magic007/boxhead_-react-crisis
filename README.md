
# 僵尸危机 3 (Boxhead Tribute) - React 重制版

这是一个基于 **React**, **TypeScript**, 和 **HTML5 Canvas** 的经典 Flash 游戏《僵尸危机 (Boxhead)》的高清复刻版。游戏使用了 **Matter.js** 物理引擎来实现真实的碰撞、击退和爆炸效果。

## 📂 项目文件结构

```text
src/
├── App.tsx                 # 应用主组件 (路由/菜单/游戏容器)
├── constants.ts            # 游戏常量 (速度, 伤害, 颜色, 地图大小, 难度配置)
├── types.ts                # TypeScript 类型定义 (实体, 武器枚举, 难度枚举)
├── index.tsx               # 入口文件
├── components/
│   ├── GameCanvas.tsx      # 游戏主入口 (Refs初始化, 循环编排)
│   ├── UIOverlay.tsx       # 游戏 UI (血条, 分数, 弹药)
│   ├── KeybindingModal.tsx # 按键设置弹窗界面
│   └── game/               # 游戏核心子系统
│       ├── types.ts        # 游戏上下文 (GameRefs) 定义
│       ├── inputConfig.ts  # 按键映射配置与持久化
│       ├── mapSystem.ts    # 地图生成逻辑 (墙体坐标计算)
│       ├── physicsSystem.ts# 物理引擎配置 (碰撞监听, 爆炸效果)
│       ├── soundSystem.ts  # 音效合成系统 (Web Audio API)
│       ├── updateSystem.ts # 游戏逻辑更新 (移动, AI, 射击, 生成)
│       ├── renderSystem.ts # Canvas 渲染器 (绘图指令)
│       └── utils.ts        # 通用工具函数 (距离计算, 粒子生成)
```

## 🎮 游戏操作

所有按键均支持 **自定义**，设置会自动保存。

### 单人游戏 (1P)
| 默认按键 | 功能 |
| --- | --- |
| **W A S D** | 移动角色 |
| **Space** | 攻击 / 射击 / 放置物品 (按住可连发) |
| **1 - 6** | 切换武器 (手枪 / 冲锋枪 / 霰弹枪 / 假墙 / 油桶 / 大炮) |
| **Q** | 循环切换武器 (按顺序切换：手枪→冲锋枪→霰弹枪→假墙→油桶→大炮→手枪) |
| **鼠标** | 瞄准 (角色会自动朝向准星) |
| **鼠标左键** | 也可以攻击 |

### 双人合作 (2P)
| 玩家 | 移动 | 攻击 | 换枪 | 循环切换 |
| --- | --- | --- | --- | --- |
| **P1** | WASD | Space / 鼠标左键 | 1-6 | Q |
| **P2** | 方向键 | 小键盘 0 | 小键盘 1-6 | 小键盘回车 |

*注：P2 默认自动瞄准最近的敌人。*

| 通用按键 | 功能 |
| --- | --- |
| **Esc** | 暂停游戏 |

### 手柄支持 (Gamepad)

游戏完整支持标准游戏手柄，支持以下操作：

| 手柄按键 | 功能 |
| --- | --- |
| **左摇杆** | 移动角色 |
| **右摇杆** | 瞄准方向 |
| **A 按钮 / RT 扳机** | 攻击 / 射击 |
| **X 按钮 / RB** | 循环切换武器（下一个） |
| **LB** | 切换到上一个武器 |
| **方向键** | 快速选择武器（上：手枪，右：冲锋枪，下：霰弹枪，左：假墙） |
| **Start / Menu** | 暂停游戏 |

*注：手柄输入与键盘/鼠标输入兼容，手柄优先。可在通用设置中检测手柄连接状态。*

### 通用设置

在游戏主菜单或暂停菜单中点击"按键设置"，可以进入通用设置界面：

*   **游戏难度**: 可选择简单、中等、困难三个难度级别
    *   **简单**: 僵尸生成率、数量、速度和血量降低 30-35%，适合新手玩家
    *   **中等**: 标准难度，各项参数为基准值
    *   **困难**: 僵尸生成率、数量、速度和血量提高 35-40%，恶魔出现概率更高，适合挑战
    *   难度设置会自动保存，与动态难度系统叠加使用
*   **生命数量**: 可设置每位玩家的初始生命数（1-10）
*   **虚拟按键** (移动端): 可开启/关闭虚拟控制按钮
*   **手柄检测**: 点击"检测手柄"按钮可查看当前连接的手柄信息和支持状态
*   **全屏模式**: 一键进入全屏，提供沉浸式体验

### 移动端支持 (Mobile)
游戏会自动检测移动设备，并提供以下特性：
*   **拖拽式虚拟摇杆**: 左侧提供类似王者荣耀的拖拽式摇杆，支持8方向移动
    *   按下并拖拽摇杆球即可控制角色移动
    *   支持对角线移动，操作流畅自然
    *   摇杆球实时跟随手指位置，提供视觉反馈
*   **虚拟操作按钮**: 右侧显示攻击和武器切换按钮
    *   攻击按钮：按住可连续射击
    *   武器切换按钮：点击循环切换武器
*   **多点触控优化**: 支持同时操作攻击和方向，互不干扰
*   **全屏模式**: 支持一键进入全屏，提供沉浸式体验
*   **触控瞄准**: 点击屏幕空白处即可控制角色朝向

## 🖼️ 游戏截图
![游戏截图 1](./images/play.gif)

![游戏截图 1](./images/game1.png)

![游戏截图 2](./images/game2.png)

![游戏截图 3](./images/game3.png)

## ✨ 游戏特性

*   **物理引擎驱动**: 使用 `Matter.js` 实现真实的物体交互。
    *   **击退效果**: 子弹击中僵尸会产生基于物理的击退力，且在僵尸群中具有传导性。
    *   **爆炸冲击**: 油桶爆炸会将周围的实体炸飞。
    *   **碰撞判定**: 玩家具有超高“质量”，在尸潮中巍然不动，只会持续掉血，不会被推动。
*   **高度可配置**:
    *   **双人合作**: 支持本地双人同屏作战，每位玩家拥有独立血条和弹药。
    *   **自定义按键**: 支持玩家重新绑定所有操作按键（包括武器切换按键），并持久化保存。
    *   **手柄支持**: 完整支持标准游戏手柄，包括移动、瞄准、射击、武器切换和暂停功能。
    *   **难度设置**: 可选择简单/中等/困难三个难度级别，影响僵尸生成率、数量、速度和血量，设置会自动保存。
    *   **生命数量**: 可自定义每位玩家的初始生命数（1-10）。
    *   **暂停系统**: 战斗中可随时暂停，调整配置或休息。
*   **智能辅助**:
    *   **自动瞄准**: 当敌人进入射程时，持枪状态下会自动锁定最近的敌人。
    *   **无阻挡放置**: 玩家放置的假墙不会卡住自己（Collision Mask 过滤），但会阻挡僵尸。
*   **双重难度系统**:
    *   **基础难度**: 玩家可在设置中选择简单/中等/困难三个难度级别，影响僵尸生成率、最大数量、移动速度和血量。
    *   **动态难度**: 随着杀敌数增加，僵尸和恶魔的数量会不断增多。
    *   **分数增强**: 每获得 10,000 分，怪物生成速度和上限会额外提升 10%，并伴有红色警报提示。
    *   **叠加机制**: 基础难度设置与动态难度系统叠加使用，为玩家提供更丰富的挑战体验。
*   **连击系统**: 快速击杀敌人可以积累倍率 (Multiplier)，获得更高分数。
*   **超大地图**: 1600x1200 的超大战场，配备摄像机跟随系统。
*   **防御工事**: 地图自带三道带有交错缺口的防线，玩家可自由建造墙体和炸药桶。
*   **武器系统**:
    *   **6种武器**: 手枪、冲锋枪、霰弹枪、假墙、油桶、大炮
    *   **快速切换**: 支持数字键快速选择或循环切换按键顺序切换
    *   **大炮**: 高伤害、低散射的重型武器，适合对付大量敌人
*   **平衡性优化**:
    *   **红色僵尸（恶魔）**: 病毒攻击间隔从2秒增加到3秒，病毒飞行速度降低，降低威胁度
    *   **移动端体验**: 拖拽式摇杆提供流畅的操作体验，支持多点触控同时操作

## 🛠️ 技术架构

项目采用模块化设计，将游戏逻辑拆分为多个子系统，位于 `src/components/game/` 目录下：

### 核心模块

1.  **`GameCanvas.tsx` (编排器)**
    *   管理 React 生命周期。
    *   初始化 `GameRefs`（包含所有游戏状态的可变引用）。
    *   启动 `requestAnimationFrame` 游戏主循环。
    *   管理游戏状态（播放、暂停、结束）。

2.  **`physicsSystem.ts` (物理系统)**
    *   集成 `Matter.js`。
    *   **高密度玩家**: 设置玩家密度为 100，确保不被僵尸推动。
    *   **持续伤害**: 在 `collisionActive` 中处理僵尸对玩家的持续接触伤害。
    *   处理爆炸逻辑 (`createExplosion`)：施加径向力。

3.  **`updateSystem.ts` (逻辑更新)**
    *   每一帧的逻辑运算。
    *   **输入处理**: 从 `KeyMap` 读取动态按键映射。
    *   **多玩家支持**: 循环处理玩家数组的移动、射击逻辑。
    *   **AI 行为**: 寻路、朝向玩家、受击硬直 (Stun) 逻辑。
    *   **难度控制**: 支持用户选择的基础难度设置（简单/中等/困难），同时监控分数变化动态调整 `spawnRate` 和 `maxEnemies`，两者叠加使用。

4.  **`renderSystem.ts` (渲染系统)**
    *   纯 Canvas 2D 绘图。
    *   处理摄像机偏移 (Camera Transform)。
    *   绘制 UI 消息 (Game Message)、背景、血迹、墙体、实体、子弹轨迹、粒子效果。

5.  **`soundSystem.ts` (音效系统)**
    *   使用 Web Audio API 实时合成枪声、爆炸声和拾取音效，不依赖外部音频文件。

## 🚀 运行项目

本项目使用标准的 React 构建工具。

1.  **安装依赖**
    ```bash
    npm install
    ```

2.  **启动开发服务器**
    ```bash
    npm start
    ```

3.  **构建生产版本**
    ```bash
    npm run build
    ```

## 📝 开发备注

*   **性能优化**: 游戏状态存储在 `useRef` 中而不是 `useState`，以避免 React 在每帧 60 次的频率下重新渲染组件。只有 UI 层（血条、分数）会低频触发 React 更新。
*   **物理参数**: 调整 `constants.ts` 中的 `PLAYER_SPEED`, `ZOMBIE_SPEED` 可以改变游戏节奏。

---
*致敬经典 Flash 游戏 Boxhead 系列*
