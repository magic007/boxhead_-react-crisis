# 僵尸寻路系统说明

## 概述
为了解决僵尸遇到障碍物时卡住的问题,我们实现了基于A*算法的智能寻路系统。

## 🎯 核心优化策略：直线优先 + 按需寻路

**V3 性能优化**：僵尸不再盲目使用A*算法，而是采用智能策略：
1. **默认直线追击**：僵尸看到玩家时直接冲过去
2. **视线检测**：每15帧检查一次是否有障碍物阻挡视线
3. **按需寻路**：只有在被墙挡住或卡住时才启动A*算法
4. **自动切换**：清除障碍后立即切回直线模式

**性能提升**：大幅减少A*计算，避免卡顿！

## 主要特性

### 1. 视线检测系统（LOS - Line of Sight）🆕
- **使用Bresenham直线算法**进行快速射线检测
- 每15帧检查一次僵尸到玩家之间是否有障碍物
- 检测距离限制在500像素内（远距离直接假设需要寻路）
- **核心逻辑**：有视线 = 直线追击，无视线 = 启动A*寻路

### 2. 网格化地图
- 将游戏世界划分为32x32像素的网格
- 自动标记墙壁和障碍物所在的网格为不可通行
- 每20帧更新一次网格,快速感知地图变化

### 3. A*寻路算法（按需触发）
- **仅在需要时运行**：检测到障碍物阻挡视线时才启动
- 使用经典的A*算法寻找从僵尸到玩家的最短路径
- 支持8方向移动(上下左右+4个对角线)
- 对角线移动时检查是否会"切角",避免穿墙
- 如果目标位置被阻挡,自动在8格范围内寻找可通行位置
- **最大迭代次数800次**（平衡性能和复杂度），能够处理复杂的绕路场景
- **使用加权启发式函数**（权重0.8），让A*更愿意探索绕路，而不是过度追求直线

### 4. 路径缓存与智能切换
- **状态标记**：每个僵尸有`needsPathfinding`标志，控制是否使用A*
- **自动切换**：检测到视线清晰时，立即切换回直线模式
- 每个僵尸缓存自己的路径,不需要每帧都计算
- 每45帧重新计算一次路径（仅在寻路模式下）
- 当目标玩家移动超过80像素时,立即重新计算路径
- 僵尸到达路径上的某个点后,自动移向下一个点

### 5. 卡住检测与恢复
- **卡住检测**：每30帧检测一次僵尸是否移动距离 < 3像素
- **强制寻路**：检测到卡住时，立即启动A*寻路绕过障碍
- **失败重试**：如果找不到路径，15帧后快速重试
- 被击中时的眩晕效果仍然有效
- 恶魔(Devil)的远程攻击不受寻路影响

## 技术实现

### 新增文件
- `components/game/pathfinding.ts`: 寻路算法核心实现

### 修改文件
1. `types.ts`: 为Entity添加了路径相关属性
   - `path`: 缓存的路径数组
   - `pathUpdateTimer`: 路径更新计时器
   - `targetPosition`: 目标位置

2. `components/game/updateSystem.ts`: 集成寻路系统到僵尸AI
   - 每帧更新障碍物网格(节流处理)
   - 为每个僵尸计算和跟随路径
   - 保持原有的战斗和眩晕逻辑

## 性能优化（V3 重大优化）

### 核心优化：按需计算
- **视线检测优先**：每15帧一次LOS检查（开销极小）
- **A*按需触发**：只有约30-40%的僵尸需要寻路（大幅减少计算量）
- **自动降级**：障碍清除后立即切回直线模式

### 具体指标
- **网格更新**: 20帧一次，更快感知地图变化
- **视线检测**: 15帧一次，使用高效的Bresenham算法
- **路径计算**: 45帧一次（仅在寻路模式下）
- **A*迭代限制**: 最多800次迭代，平衡性能和路径复杂度
- **路径跟随**: 简单的距离检查，开销极小
- **智能重试**: 找不到路径时15帧后重试

### 性能对比
| 版本 | 每帧A*调用次数 | 性能影响 |
|------|---------------|---------|
| V1 | 所有僵尸 | 重度卡顿 |
| V2 | 所有僵尸/45帧 | 中度卡顿 |
| V3 | 仅被阻挡僵尸/45帧 | **流畅** |

## 针对地图三道墙的优化
游戏地图有三道横向墙壁，缺口是错开的（左-中-右）：
- Wall 1 (y=400): 缺口在左侧
- Wall 2 (y=800): 缺口在中央  
- Wall 3 (y=1100): 缺口在右侧

**优化措施**：
1. 增加A*最大迭代次数，允许计算更长的路径
2. 降低启发式函数权重，让算法更愿意探索左右绕行
3. 扩大目标搜索范围，即使玩家在障碍物后面也能找到可达点
4. 添加卡住检测，僵尸在原地不动时会强制重新寻路

## 实际效果

### 僵尸行为表现
僵尸现在能够:
- ✅ **空旷地带**：看到玩家直接冲锋，速度快、反应灵敏
- ✅ **遇到障碍**：自动切换到寻路模式，智能绕行
- ✅ **通过复杂地形**：能穿过三道错开的墙壁缺口
- ✅ **动态适应**：障碍清除后立即恢复直线追击
- ✅ **卡住恢复**：被困时强制启动寻路，不会永久卡住
- ✅ **流畅体验**：**彻底解决卡顿问题**，游戏运行流畅

### 典型场景
1. **场景A**：僵尸在远处看到玩家
   - ❌ 旧版：立即运行A*算法（浪费）
   - ✅ 新版：检测到视线清晰，直接冲锋

2. **场景B**：玩家躲在假墙后面
   - ❌ 旧版：僵尸撞墙卡住或持续运行A*
   - ✅ 新版：检测到阻挡，启动寻路绕过障碍

3. **场景C**：玩家炸掉挡路的假墙
   - ❌ 旧版：僵尸还在绕路（路径缓存未更新）
   - ✅ 新版：15帧内检测到视线清晰，立即直冲

